name: firmware-stable
on:
  workflow_dispatch:
    inputs:
      branch:
        type: choice
        description: 'Branch to build from'
        required: false
        default: 'stable'
        options:
          - stable
          - master
          - iborder

      board_list:
        type: string
        description: 'Comma-separated list of boards to build (e.g. board1,board2)'
        required: false

      debug_enabled:
        type: boolean
        description: 'Enable debug build with sanitizers'
        required: false
        default: false

env:
  BR2_DL_DIR: ~/dl
  FORCE_UNSAFE_CONFIGURE: 1
  TERM: linux
  TZ: Asia/Shanghai
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-matrix:
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Configure GH workspace
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "0"

      - name: Debug checked out branch and commit
        run: |
          echo "Checked out branch:"
          git branch -a
          echo "HEAD SHA:"
          git rev-parse HEAD
          echo "Last commit:"
          git log --oneline -1

      - name: Generate device matrix
        id: set-matrix
        run: |
          if [[ -n "${{ github.event.inputs.board_list }}" ]]; then
            CONFIGS=$(echo "${{ github.event.inputs.board_list }}" | tr ',' '\n')
          else
            CONFIGS=$(find configs/cameras/ -type f -name "*defconfig" | sort | sed 's|.*/\(.*\)_defconfig|\1|')
          fi
          JSON_MATRIX="{\"thingino-version\": ["
          for CONFIG in $CONFIGS; do
            JSON_MATRIX+="\"${CONFIG}\","
          done
          JSON_MATRIX="${JSON_MATRIX%,}]}"
          echo "Matrix: $JSON_MATRIX"
          echo "matrix=$JSON_MATRIX" >> $GITHUB_OUTPUT

  build-prudynt-t:
    name: ${{ matrix.thingino-version }}
    needs: generate-matrix
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
    container:
      image: debian:trixie
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    steps:
      - name: Update package manager sources
        run: |
          apt-get update

      - name: Install GitHub CLI to container
        run: |
          apt-get update
          apt-get install -y curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null

      - name: Update package manager sources
        run: |
          apt-get update

      - name: Install build dependencies
        run: |
          apt-get install -y --no-install-recommends --no-install-suggests autoconf build-essential bc cmake cpio curl ca-certificates file git gh make gawk jq m4 p7zip-full perl procps python3 rsync tzdata u-boot-tools unzip wget
      - name: Set timezone
        run: |
          ln -sf /usr/share/zoneinfo/${{ env.TZ }} /etc/localtime
          echo ${{ env.TZ }} > /etc/timezone
          DEBIAN_FRONTEND=noninteractive dpkg-reconfigure -f noninteractive tzdata

      - name: Setup gh workspace to container
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout repository source
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "0"

      - name: Debug checked out branch and commit
        run: |
          echo "Checked out branch:"
          git branch -a
          echo "HEAD SHA:"
          git rev-parse HEAD
          echo "Last commit:"
          git log --oneline -1

      - name: Configure environment variables
        run: |
          echo "WEEK_NUMBER=$(date +%U)" >> $GITHUB_ENV
          echo "CURRENT_YEAR=$(date +%Y)" >> $GITHUB_ENV
          echo "GIT_HASH=$(git rev-parse --short ${GITHUB_SHA})" >> $GITHUB_ENV
          echo "GIT_BRANCH=$(git branch --show-current)" >> $GITHUB_ENV

      - name: Setup cache directories
        run: |
          mkdir -p ~/.ccache
          mkdir -p ~/dl

      - name: Restore build cache
        uses: actions/cache@v4
        if: always()
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-${{ env.CURRENT_YEAR }}-week-${{ env.WEEK_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-${{ env.CURRENT_YEAR }}-
            ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-

      - name: Fetch buildroot-dl-cache release
        id: find_release
        run: |
          REPO="themactep/thingino-firmware"
          RELEASE_TAG=$(gh release list --repo "$REPO" --json name,tagName | jq -r '.[] | select(.name=="buildroot-dl-cache") | .tagName' | sort -r | head -1 || echo "")
          if [ -z "$RELEASE_TAG" ]; then
            echo "Could not find release with name 'buildroot-dl-cache', trying tags starting with 'update_cache'"
            RELEASE_TAG=$(gh release list --repo "$REPO" --json tagName | jq -r '.[] | select(.tagName | startswith("update_cache")) | .tagName' | head -n 1 || echo "")
          fi
          if [ -n "$RELEASE_TAG" ]; then
            echo "Found release with tag: $RELEASE_TAG"
            echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
            echo "release_found=true" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not find appropriate release, continuing without cache"
            echo "release_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Download buildroot-dl-cache files
        id: download_cache
        if: steps.find_release.outputs.release_found == 'true'
        run: |
          REPO="themactep/thingino-firmware"
          RELEASE_TAG="${{ steps.find_release.outputs.release_tag }}"
          mkdir -p /tmp/dl-cache
          echo "Downloading files from release with tag: $RELEASE_TAG"
          set +e
          gh release download "$RELEASE_TAG" --repo "$REPO" --pattern "buildroot-dl-cache*" --dir "/tmp/dl-cache"
          DOWNLOAD_EXIT_CODE=$?
          set -e
          if [ $DOWNLOAD_EXIT_CODE -ne 0 ]; then
            echo "Warning: gh command exited with code $DOWNLOAD_EXIT_CODE."
            echo "download_succeeded=false" >> $GITHUB_OUTPUT
          elif [ ! "$(ls -A /tmp/dl-cache/)" ]; then
            echo "Warning: Download directory is empty, no files were downloaded."
            echo "download_succeeded=false" >> $GITHUB_OUTPUT
          else
            echo "Download successful!"
            echo "download_succeeded=true" >> $GITHUB_OUTPUT
          fi
          echo "Downloaded files:"
          ls -la /tmp/dl-cache/ || echo "No files found."

      - name: Extract buildroot-dl-cache
        if: steps.download_cache.outputs.download_succeeded == 'true'
        run: |
          if ls /tmp/dl-cache/buildroot-dl-cache.zip.* &>/dev/null; then
            echo "Extracting split ZIP files..."
            cd ~
            7z x /tmp/dl-cache/buildroot-dl-cache.zip.001 -y
          else
            echo "Extracting single ZIP file..."
            cd ~
            7z x /tmp/dl-cache/buildroot-dl-cache.zip -y
          fi
          if [ -d ~/dl/dl ]; then
            echo "Moving files from ~/dl/dl to ~/dl"
            mv ~/dl/dl/* ~/dl/
            rm -rf ~/dl/dl
          fi
          echo "Verifying extraction:"
          ls -la ~/dl/
          echo "Number of files in ~/dl:"
          find ~/dl -type f | wc -l
          echo "DL cache restored successfully"

      - name: Download buildroot sources if cache missing
        if: steps.find_release.outputs.release_found != 'true' || steps.download_cache.outputs.download_succeeded != 'true'
        run: |
          echo "Buildroot DL cache not available, downloading sources..."
          BOARD=${{ matrix.thingino-version }} make source WORKFLOW=1
          echo "Source download completed"

      - name: Update prudynt-t.mk configuration
        run: |
          # Update prudynt-t.mk file with correct repository information
          sed -i '3c PRUDYNT_T_SITE = https://github.com/iborderxm/prudynt-t-fork' package/prudynt-t/prudynt-t.mk
          sed -i '4c PRUDYNT_T_SITE_BRANCH = iborder' package/prudynt-t/prudynt-t.mk
          sed -i '5c PRUDYNT_T_VERSION = $(shell git ls-remote $(PRUDYNT_T_SITE) $(PRUDYNT_T_SITE_BRANCH) | head -1 | cut -f1)' package/prudynt-t/prudynt-t.mk
          # Verify the changes
          echo "Updated prudynt-t.mk file:"
          pwd
          cat package/prudynt-t/prudynt-t.mk | head -10

      - name: Build prudynt-t only
        run: |
          echo "Building prudynt-t for ${{ matrix.thingino-version }}..."
          if [ "${{ github.event.inputs.debug_enabled }}" == "true" ]; then
            BOARD=${{ matrix.thingino-version }} make prudynt-t-rebuild DEBUG=1 WORKFLOW=1
          else
            BOARD=${{ matrix.thingino-version }} make prudynt-t-rebuild WORKFLOW=1
          fi
          echo "prudynt-t build completed"

      - name: Verify prudynt-t binary
        run: |
          echo "Verifying prudynt-t binary..."
          PRUDYNT_BIN=$(find output/${{ github.event.inputs.branch || 'stable' }}/${{ matrix.thingino-version }}/target/usr/bin -name "prudynt" 2>/dev/null | head -n 1)
          if [ -z "$PRUDYNT_BIN" ]; then
            echo "ERROR: prudynt binary not found"
            exit 1
          fi
          echo "Found prudynt binary: $PRUDYNT_BIN"
          ls -lh "$PRUDYNT_BIN"
          file "$PRUDYNT_BIN"

      - name: Upload prudynt-t binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: prudynt-t-${{ matrix.thingino-version }}
          path: |
            output/${{ github.event.inputs.branch || 'stable' }}/${{ matrix.thingino-version }}/target/usr/bin/prudynt
            output/${{ github.event.inputs.branch || 'stable' }}/${{ matrix.thingino-version }}/target/usr/bin/prudyntctl
          if-no-files-found: error

      - name: Display build summary
        run: |
          echo "=========================================="
          echo "prudynt-t Build Summary for ${{ matrix.thingino-version }}"
          echo "=========================================="
          echo "Branch: ${{ github.event.inputs.branch || 'stable' }}"
          echo "Git Hash: ${{ env.GIT_HASH }}"
          echo "Debug Build: ${{ github.event.inputs.debug_enabled }}"
          echo "=========================================="
