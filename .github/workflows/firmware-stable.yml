name: firmware-stable
on:
  workflow_dispatch:
    inputs:
      branch:
        type: choice
        description: 'Branch to build from'
        required: false
        default: 'stable'
        options:
          - stable
          - master
          - iborder

      graph_enabled:
        type: boolean
        description: 'Enable build time graph'
        required: false
        default: false
      teacup_only:
        type: boolean
        description: 'Only build Tea Cup profile'
        required: false
        default: false
      debug_enabled:
        type: boolean
        description: 'Debug: Generate dummy image files'
        required: false
        default: false
      update_prudynt_config:
        type: boolean
        description: 'Update prudynt-t.mk configuration'
        required: false
        default: false
      board_list:
        type: string
        description: 'Comma-separated list of boards to build (e.g. board1,board2)'
        required: true

env:
  BR2_DL_DIR: ~/dl
  FORCE_UNSAFE_CONFIGURE: 1
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TAG_NAME: firmware
  TERM: linux

  TZ: Asia/Shanghai

jobs:
  check-updates:
    runs-on: ubuntu-24.04
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: 0

      - name: Debug checked out branch and commit
        run: |
          echo "Checked out branch:"
          git branch -a
          echo "HEAD SHA:"
          git rev-parse HEAD
          echo "Last commit:"
          git log --oneline -1

      - name: Check for updates since last release
        id: check
        run: |
          # Always build if manually triggered
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger detected - building"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          LATEST_RELEASE=$(gh release list --repo ${{ github.repository }} --json tagName,name | jq -r '.[] | select(.name | startswith("firmware-")) | .tagName' | head -1)
          if [[ -z "$LATEST_RELEASE" ]]; then
            echo "No previous firmware release found - building"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Latest firmware release: $LATEST_RELEASE"
          LATEST_RELEASE_COMMIT=$(gh api repos/${{ github.repository }}/git/ref/tags/$LATEST_RELEASE | jq -r '.object.sha')
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "Latest release commit: $LATEST_RELEASE_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"
          if [[ "$LATEST_RELEASE_COMMIT" == "$CURRENT_COMMIT" ]]; then
            echo "No new commits since last release - skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New commits detected since last release - building"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  notify-no-build:
    runs-on: ubuntu-24.04
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'false'
    steps:
      - name: Log no build needed
        run: |
          echo "No new commits detected since last firmware release."
          echo "Skipping scheduled build. Manual runs always build."

  prepare-release:
    runs-on: ubuntu-24.04
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    outputs:
      tag_name: ${{ steps.set_tag.outputs.tag_name }}
    steps:
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Configure TAG_NAME
        id: set_tag
        run: |
          BRANCH=${{ github.event.inputs.branch || 'stable' }}
          TAG_NAME="$TAG_NAME-$BRANCH-$(TZ=Asia/Shanghai date +'%Y-%m-%d-%H-%M')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "1"

      - name: Create release tag
        continue-on-error: true
        run: |
          TAG_NAME="${{ env.TAG_NAME }}"
          if ! gh api repos/${{ github.repository }}/git/ref/tags/$TAG_NAME &>/dev/null; then
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          else
            echo "Tag $TAG_NAME already exists."
          fi

      - name: Create release
        continue-on-error: true
        run: |
          TAG_NAME="${{ env.TAG_NAME }}"
          if ! gh release view "$TAG_NAME" --repo "${{ github.repository }}" &>/dev/null; then
            echo "Release $TAG_NAME does not exist. Creating pre-release."
            gh release create "$TAG_NAME" --repo "${{ github.repository }}" --title "$TAG_NAME" --notes "pre-release: \`\`\`$TAG_NAME\`\`\` is currently being built, please wait..." --prerelease
          else
            echo "Release $TAG_NAME already exists."
          fi

  notify-begin:
    runs-on: ubuntu-24.04
    needs: prepare-release
    if: needs.check-updates.outputs.should_build == 'true'
    outputs:
      start_time: ${{ steps.set_output.outputs.time }}
    steps:
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Save workflow start time to ENV
        id: set_output
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Configure Environment Variables
        id: set_env
        run: |
          echo "TAG_NAME=${{ needs.prepare-release.outputs.tag_name }}" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "1"



  generate-matrix:
    runs-on: ubuntu-24.04
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Configure GH workspace
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "0"

      - name: Debug checked out branch and commit
        run: |
          echo "Checked out branch:"
          git branch -a
          echo "HEAD SHA:"
          git rev-parse HEAD
          echo "Last commit:"
          git log --oneline -1

      - name: Generate device matrix
        id: set-matrix
        run: |
          if [[ -n "${{ github.event.inputs.board_list }}" ]]; then
            CONFIGS=$(echo "${{ github.event.inputs.board_list }}" | tr ',' '\n')
          elif [[ "${{ github.event.inputs.teacup_only }}" == 'true' ]]; then
            CONFIGS=$(find configs/cameras/ -type f -name "*defconfig" | sort | sed 's|.*/\(.*\)_defconfig|\1|' | grep teacup)
          else
            CONFIGS=$(find configs/cameras/ -type f -name "*defconfig" | sort | sed 's|.*/\(.*\)_defconfig|\1|')
          fi
          JSON_MATRIX="{\"thingino-version\": ["
          for CONFIG in $CONFIGS; do
            JSON_MATRIX+="\"${CONFIG}\","
          done
          JSON_MATRIX="${JSON_MATRIX%,}]}"
          echo "Matrix: $JSON_MATRIX"
          echo "matrix=$JSON_MATRIX" >> $GITHUB_OUTPUT

  buildroot:
    name: ${{ matrix.thingino-version }}
    needs: [generate-matrix, notify-begin, prepare-release]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    outputs:
      GIT_HASH: ${{ steps.env.outputs.git_hash }}
      TAG_NAME: ${{ steps.env.outputs.tag_name }}
    defaults:
      run:
        shell: bash
    container:
      image: debian:trixie
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    steps:
      - name: Install GitHub CLI to container
        run: |
          apt-get update
          apt-get install -y curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null

      - name: Update package manager sources
        run: |
          apt-get update

      - name: Install build dependencies
        run: |
          apt-get install -y --no-install-recommends --no-install-suggests autoconf build-essential bc cmake cpio curl ca-certificates file git gh make gawk jq m4 p7zip-full perl procps python3 rsync tzdata u-boot-tools unzip wget

      - name: Checkout prudynt-t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_TOKEN }}
          repository: iborderxm/prudynt-t
          path: ./prudynt-t

      - name: Prepare prudynt-t
        run: |
          ls -ltr ./prudynt-t/
          mv ./prudynt-t /tmp/prudynt-t
          cd /tmp/prudynt-t
          git fetch --all

          TAG=$(git tag --sort=-v:refname | head -1)
          echo "Latest Tag: $TAG"
          
          if [ -z "$TAG" ]; then
            echo "ERROR: No tags found in repository"
            exit 1
          fi
          
          git checkout $TAG
          cd /tmp
          ls -ltr prudynt-t/include/
          mv prudynt-t prudynt-t-${TAG}
          tar -czf ./prudynt-t-${TAG}.tar.gz prudynt-t-${TAG}
          ls -ltr
          mkdir webdir
          mv ./prudynt-t-${TAG}.tar.gz ./webdir/

          echo "PRUDYNT_T_TAG=${TAG}" >> $GITHUB_ENV
          cd $GITHUB_WORKSPACE
      
      - name: Set timezone
        run: |
          ln -sf /usr/share/zoneinfo/${{ env.TZ }} /etc/localtime
          echo ${{ env.TZ }} > /etc/timezone
          DEBIAN_FRONTEND=noninteractive dpkg-reconfigure -f noninteractive tzdata

      - name: Setup gh workspace to container
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout repository source
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          ref: ${{ github.event.inputs.branch || 'stable' }}
          fetch-depth: "0"

      - name: Debug checked out branch and commit
        run: |
          echo "Checked out branch:"
          git branch -a
          echo "HEAD SHA:"
          git rev-parse HEAD
          echo "Last commit:"
          git log --oneline -1

      - name: Configure environment variables
        id: env
        run: |
          echo "WEEK_NUMBER=$(date +%U)" >> $GITHUB_ENV
          echo "CURRENT_YEAR=$(date +%Y)" >> $GITHUB_ENV
          echo "GIT_HASH=$(git rev-parse --short ${GITHUB_SHA})" >> $GITHUB_ENV
          echo "GIT_BRANCH=$(git branch --show-current)" >> $GITHUB_ENV
          echo "TAG_NAME=${{ needs.prepare-release.outputs.tag_name }}" >> $GITHUB_ENV

          echo "GIT_HASH=$(git rev-parse --short ${GITHUB_SHA})" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${{ needs.prepare-release.outputs.tag_name }}" >> $GITHUB_OUTPUT

      - name: Setup cache directories
        run: |
          mkdir -p ~/.ccache
          mkdir -p ~/dl

      - name: Restore build cache
        uses: actions/cache@v4
        if: always()
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-${{ env.CURRENT_YEAR }}-week-${{ env.WEEK_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-${{ env.CURRENT_YEAR }}-
            ${{ runner.os }}-ccache-${{ matrix.thingino-version }}-

      - name: Fetch buildroot-dl-cache release
        id: find_release
        run: |
          REPO="themactep/thingino-firmware"
          RELEASE_TAG=$(gh release list --repo "$REPO" --json name,tagName | jq -r '.[] | select(.name=="buildroot-dl-cache") | .tagName' | sort -r | head -1 || echo "")
          if [ -z "$RELEASE_TAG" ]; then
            echo "Could not find release with name 'buildroot-dl-cache', trying tags starting with 'update_cache'"
            RELEASE_TAG=$(gh release list --repo "$REPO" --json tagName | jq -r '.[] | select(.tagName | startswith("update_cache")) | .tagName' | head -n 1 || echo "")
          fi
          if [ -n "$RELEASE_TAG" ]; then
            echo "Found release with tag: $RELEASE_TAG"
            echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
            echo "release_found=true" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not find appropriate release, continuing without cache"
            echo "release_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Download buildroot-dl-cache files
        id: download_cache
        if: steps.find_release.outputs.release_found == 'true'
        run: |
          REPO="themactep/thingino-firmware"
          RELEASE_TAG="${{ steps.find_release.outputs.release_tag }}"
          mkdir -p /tmp/dl-cache
          echo "Downloading files from release with tag: $RELEASE_TAG"
          set +e
          gh release download "$RELEASE_TAG" --repo "$REPO" --pattern "buildroot-dl-cache*" --dir "/tmp/dl-cache"
          DOWNLOAD_EXIT_CODE=$?
          set -e
          if [ $DOWNLOAD_EXIT_CODE -ne 0 ]; then
            echo "Warning: gh command exited with code $DOWNLOAD_EXIT_CODE."
            echo "download_succeeded=false" >> $GITHUB_OUTPUT
          elif [ ! "$(ls -A /tmp/dl-cache/)" ]; then
            echo "Warning: Download directory is empty, no files were downloaded."
            echo "download_succeeded=false" >> $GITHUB_OUTPUT
          else
            echo "Download successful!"
            echo "download_succeeded=true" >> $GITHUB_OUTPUT
          fi
          echo "Downloaded files:"
          ls -la /tmp/dl-cache/ || echo "No files found."

      - name: Extract buildroot-dl-cache
        if: steps.download_cache.outputs.download_succeeded == 'true'
        run: |
          if ls /tmp/dl-cache/buildroot-dl-cache.zip.* &>/dev/null; then
            echo "Extracting split ZIP files..."
            cd ~
            7z x /tmp/dl-cache/buildroot-dl-cache.zip.001 -y
          else
            echo "Extracting single ZIP file..."
            cd ~
            7z x /tmp/dl-cache/buildroot-dl-cache.zip -y
          fi
          if [ -d ~/dl/dl ]; then
            echo "Moving files from ~/dl/dl to ~/dl"
            mv ~/dl/dl/* ~/dl/
            rm -rf ~/dl/dl
          fi
          echo "Verifying extraction:"
          ls -la ~/dl/
          echo "Number of files in ~/dl:"
          find ~/dl -type f | wc -l
          echo "DL cache restored successfully"

      - name: download libimp-samples-musl
        if: ${{ github.event.inputs.update_prudynt_config != 'false' }}
        run: |
          gh repo clone gtxaspec/libimp-samples-musl /tmp/libimp-samples-musl
          echo "libimp-samples-musl cloned successfully"
          echo "libimp-samples-musl files:"
          # ls -la /tmp/libimp-samples-musl/
          # ls -la /tmp/libimp-samples-musl/T31/lib/uclibc/
          # ls -la ~/dl/ingenic-lib/
          if [ ! -f ~/dl/ingenic-lib/ingenic-lib-*-git4.tar.gz ]; then
            echo "Warning: ingenic-lib-${hashcode}-git4.tar.gz not found in ~/dl/ingenic-lib/"
            exit 1
          fi
          targzFileName=$(basename ~/dl/ingenic-lib/ingenic-lib-*-git4.tar.gz)
          echo "targzFileName: $targzFileName"
          hashcode=$(basename ~/dl/ingenic-lib/ingenic-lib-*-git4.tar.gz | cut -d '-' -f 3)
          echo "hashcode: $hashcode"

          tar -xzf ~/dl/ingenic-lib/ingenic-lib-${hashcode}*.tar.gz -C ~/dl/ingenic-lib/
          rm -f ~/dl/ingenic-lib/$targzFileName
          dirName=$(basename ~/dl/ingenic-lib/ingenic-lib-*)
          # ls -ltr
          ls -ltr ~/dl/ingenic-lib/${dirName}/
          \cp /tmp/libimp-samples-musl/T31/lib/uclibc/*.so ~/dl/ingenic-lib/${dirName}/T31/lib/1.1.6/uclibc/5.4.0/
          \cp /tmp/libimp-samples-musl/T31/lib/uclibc/*/*.so ~/dl/ingenic-lib/${dirName}/T31/lib/1.1.6/uclibc/5.4.0/
          echo "libimp-samples-musl files copied successfully"
          # ls -la ~/dl/ingenic-lib/${dirName}/T31/lib/1.1.6/uclibc/5.4.0/
          currPath=`pwd`
          cd ~/dl/ingenic-lib/
          tar -czf ./$targzFileName ${dirName}
          rm -rf ./${dirName}
          ls -ltr
          echo "$targzFileName compressed successfully"
          cd $currPath

      - name: Download buildroot sources if cache missing
        if: steps.find_release.outputs.release_found != 'true' || steps.download_cache.outputs.download_succeeded != 'true'
        run: |
          echo "Buildroot DL cache not available, downloading sources..."
          BOARD=${{ matrix.thingino-version }} make source WORKFLOW=1
          echo "Source download completed"

      - name: Update webui files
        if: ${{ github.event.inputs.update_prudynt_config != 'false' }}
        run: |
          # 复制当前项目目录到/tmp
          REPO_FULL="${{ github.repository }}"
          REPO_NAME="${REPO_FULL#*/}"
          echo "Repository name: $REPO_NAME"
          echo "copied repository to /tmp/$REPO_NAME"
          cd ../
          cp -r $REPO_NAME /tmp/$REPO_NAME
          ls -ltr /tmp/$REPO_NAME
          cd /tmp/$REPO_NAME
          git checkout iborder

          cd $GITHUB_WORKSPACE
          cp -r /tmp/$REPO_NAME/package/thingino-webui/thingino-webui.mk package/thingino-webui/thingino-webui.mk
          cp -r /tmp/$REPO_NAME/package/thingino-webui/files/S99heartbeat package/thingino-webui/files/S99heartbeat
          cp -r /tmp/$REPO_NAME/overlay/lower/cron/crontabs/root overlay/lower/cron/crontabs/root
          cp -r /tmp/$REPO_NAME/overlay/lower/etc/init.d/S37checkuenv overlay/lower/etc/init.d/S37checkuenv
          cp -r /tmp/$REPO_NAME/overlay/lower/etc/init.d/S39opc overlay/lower/etc/init.d/S39opc
          cp -r /tmp/$REPO_NAME/overlay/lower/etc/init.d/S99send2email_persondetection overlay/lower/etc/init.d/S99send2email_persondetection
          cp -r /tmp/$REPO_NAME/overlay/lower/usr/sbin/opc overlay/lower/usr/sbin/opc
          cp -r /tmp/$REPO_NAME/overlay/lower/usr/sbin/send2email_persondetection overlay/lower/usr/sbin/send2email_persondetection
          cp -r /tmp/$REPO_NAME/overlay/lower/usr/sbin/process_monitor overlay/lower/usr/sbin/process_monitor
          cp -r /tmp/$REPO_NAME/package/prudynt-t/files/prudynt.json package/prudynt-t/files/prudynt.json
          rm -rf package/thingino-portal-simple/files
          cp -r /tmp/$REPO_NAME/package/thingino-portal-simple/files package/thingino-portal-simple/files
          rm -rf package/thingino-webui/files/www
          cp -r /tmp/$REPO_NAME/package/thingino-webui/files/www package/thingino-webui/files/www
          ls -ltr package/thingino-webui/files/www | grep person

          # 替换bootstrap国内cdn
          cd package/thingino-webui/files/www
          sed -i "s|integrity=|integrity1=|g" *.html
          target_key="bootstrap.min.css"
          result=$(grep -r "$target_key" . --include="*.html" | \
          grep 'href=' | \
          sed -n 's/.*href="\([^"]*'$target_key'[^"]*\)".*/\1/p' | \
          sort | uniq)
          for item in $result
          do
              echo "$item"
              sed -i "s|$item|https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css|g" *.html
          done

          target_key="bootstrap-icons.min.css"
          result=$(grep -r "$target_key" . --include="*.html" | \
          grep 'href=' | \
          sed -n 's/.*href="\([^"]*'$target_key'[^"]*\)".*/\1/p' | \
          sort | uniq)
          for item in $result
          do
              echo "$item"
              sed -i "s|$item|https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css|g" *.html
          done

          target_key="bootstrap.bundle.min.js"
          result=$(grep -r "$target_key" . --include="*.html" | \
          grep 'src=' | \
          sed -n 's/.*src="\([^"]*'$target_key'[^"]*\)".*/\1/p' | \
          sort | uniq)
          for item in $result
          do
              echo "$item"
              sed -i "s|$item|https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js|g" *.html
          done

          cd $GITHUB_WORKSPACE
          
      - name: Update prudynt-t.mk configuration
        if: ${{ github.event.inputs.update_prudynt_config != 'false' }}
        run: |
          # Update prudynt-t.mk file with correct repository information
          sed -i 's/^PRUDYNT_T_SITE/# PRUDYNT_T_SITE/' package/prudynt-t/prudynt-t.mk
          sed -i 's/^PRUDYNT_T_VERSION/# PRUDYNT_T_VERSION/' package/prudynt-t/prudynt-t.mk
          sed -i 's/^PRUDYNT_T_GIT_SUBMODULES/# PRUDYNT_T_GIT_SUBMODULES/' package/prudynt-t/prudynt-t.mk
          sed -i '1i\PRUDYNT_T_VERSION = ${{ env.PRUDYNT_T_TAG }}' package/prudynt-t/prudynt-t.mk
          sed -i '2i\PRUDYNT_T_SOURCE = prudynt-t-$(PRUDYNT_T_VERSION).tar.gz' package/prudynt-t/prudynt-t.mk
          sed -i '3i\PRUDYNT_T_SITE = http://127.0.0.1:8000' package/prudynt-t/prudynt-t.mk
          sed -i 's/\$(shell git show -s --format=%h)/${{ env.PRUDYNT_T_TAG }}/' package/prudynt-t/prudynt-t.mk
          # Verify the changes
          echo "Updated prudynt-t.mk file:"
          pwd
          cat package/prudynt-t/prudynt-t.mk | head -200

      - name: Build firmware
        if: ${{ github.event.inputs.debug_enabled != 'true' }}
        run: |
          ls -ltr /tmp/webdir/
          cd /tmp/webdir/
          python3 -m http.server 8000 &
          sleep 5
          ps -ef | grep python
          cd $GITHUB_WORKSPACE
          ls -ltr
          BOARD=${{ matrix.thingino-version }} make fast WORKFLOW=1
          TIME=$(date -d @${SECONDS} +%M:%S)
          echo "TIME=${TIME}" >> ${GITHUB_ENV}

      - name: Generate debug dummy firmware for workflow testing
        if: ${{ github.event.inputs.debug_enabled == 'true' }}
        run: |
          DYNAMIC_PART="${{ matrix.thingino-version }}"
          mkdir -p ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/
          echo "debug" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/thingino-${DYNAMIC_PART}.bin
          echo "debug uboot" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/u-boot-lzo-with-spl.bin
          echo "debug kernel" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/uImage
          echo "debug rootfs" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/rootfs.squashfs
          echo "debug rootfs" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/rootfs.tar
          echo "debug sha" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/thingino-${DYNAMIC_PART}.bin.sha256sum
          echo "debug" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/thingino-${DYNAMIC_PART}-update.bin
          echo "debug sha" > ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/thingino-${DYNAMIC_PART}-update.bin.sha256sum
          echo "TIME=7:77" >> ${GITHUB_ENV}

      - name: Generate build time graphs
        if: ${{ github.event.inputs.graph_enabled == 'true' }}
        run: |
          apt-get install -y --no-install-recommends --no-install-suggests python3-numpy python3-matplotlib
          BOARD=${{ matrix.thingino-version }} make br-graph-build WORKFLOW=1

      - name: Validate compiled firmware artifacts
        run: |
          DYNAMIC_PART="${{ matrix.thingino-version }}"
          FW_PATH=${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}/images/
          FULL_FW=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "thingino-${DYNAMIC_PART}.bin" ! -name "*update.bin" | head -n 1)
          FULL_FW_UBOOT=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "u-boot-lzo-with-spl.bin" | head -n 1)
          FULL_FW_KERNEL=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "uImage" | head -n 1)
          FULL_FW_ROOTFS=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "rootfs.squashfs" | head -n 1)
          FULL_FW_ROOTFS_TAR=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "rootfs.tar" | head -n 1)
          UPDATE_FW=$(find ${HOME}/output/${{ github.event.inputs.branch }}/${DYNAMIC_PART}*/images/ -name "thingino-${DYNAMIC_PART}-update.bin" | head -n 1)
          echo "FULL_FW: $FULL_FW"
          if [[ -n "$FULL_FW" ]]; then
            echo "FW_PATH=${FW_PATH}" >> ${GITHUB_ENV}
            echo "FULL_FW=${FULL_FW}" >> ${GITHUB_ENV}
            echo "FULL_FW_UBOOT=${FULL_FW_UBOOT}" >> ${GITHUB_ENV}
            echo "FULL_FW_KERNEL=${FULL_FW_KERNEL}" >> ${GITHUB_ENV}
            echo "FULL_FW_ROOTFS=${FULL_FW_ROOTFS}" >> ${GITHUB_ENV}
            echo "FULL_FW_ROOTFS_TAR=${FULL_FW_ROOTFS_TAR}" >> ${GITHUB_ENV}
            echo "FULL_FW_SHA=${FULL_FW}.sha256sum" >> ${GITHUB_ENV}
            echo "UPDATE_FW=${UPDATE_FW}" >> ${GITHUB_ENV}
            echo "UPDATE_FW_SHA=${UPDATE_FW}.sha256sum" >> ${GITHUB_ENV}

            UPDATE_FW_DATETIME=$(TZ=Asia/Shanghai date +'%Y-%m-%d-%H-%M')
            echo "UPDATE_FW_DATETIME=${UPDATE_FW_DATETIME}" >> ${GITHUB_ENV}
          else
            echo "Matching .bin files not found."
            exit 1
          fi

      - name: Upload duration graph artifact
        if: ${{ github.event.inputs.graph_enabled == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.thingino-version }}-build.hist-duration
          path: |
            ~/output/${{ github.event.inputs.branch }}/${{ matrix.thingino-version }}/graphs/build.hist-duration.pdf

      - name: Upload compiled firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thingino-${{ matrix.thingino-version }}-firmware-${{ env.UPDATE_FW_DATETIME }}
          path: |
            ${{ env.FULL_FW }}
            ${{ env.FULL_FW_UBOOT }}
            ${{ env.FULL_FW_KERNEL }}
            ${{ env.FULL_FW_ROOTFS }}
            ${{ env.FULL_FW_ROOTFS_TAR }}
            ${{ env.FULL_FW_SHA }}
            ${{ env.UPDATE_FW }}
            ${{ env.UPDATE_FW_SHA }}

      - name: Post compiled firmware artifacts to release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: ${{ env.TAG_NAME }}
          make_latest: false
          prerelease: true
          files: |
            ${{ env.FULL_FW }}
            ${{ env.FULL_FW_SHA }}
            ${{ env.UPDATE_FW_SHA }}



  finalize-release:
    needs: [buildroot, prepare-release, check-updates]
    runs-on: ubuntu-24.04
    if: always() && needs.check-updates.outputs.should_build == 'true'
    steps:
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Configure Environment
        run: |
          echo "GIT_HASH=${{ needs.buildroot.outputs.git_hash }}" >> $GITHUB_ENV
          echo "TAG_NAME=${{ needs.prepare-release.outputs.tag_name }}" >> $GITHUB_ENV

      - name: Checkout repository source
        uses: actions/checkout@v4
        with:
          submodules: 'false'
          ref: ${{ github.event.inputs.branch || 'stable' }}

      - name: Generate release notes
        id: release_notes
        run: |
          GIT_HASH=$(git ls-remote origin "refs/heads/stable" | cut -f1 | cut -c1-7)
          LAST_RELEASE_TAG=$(gh release list --limit 2 --json tagName -q '.[1].tagName')
          if [ -z "$LAST_RELEASE_TAG" ]; then
            echo "No previous release found. Skipping release notes generation."
            echo "RELEASE_NOTES_FILE=$(pwd)/release_notes.md" >> $GITHUB_ENV
            exit 0
          else
            echo "Latest release so far is $LAST_RELEASE_TAG"
          fi
          COMMITS=$(gh api \
            -H "Accept: application/vnd.github.v3+json" \
            /repos/${{ github.repository }}/compare/$LAST_RELEASE_TAG...$GIT_HASH \
            -q '.commits
                | sort_by(.commit.author.date)
                | reverse
                | .[]
                | select(
                    .commit.message != "Merge remote-tracking branch '\''origin/stable'\''"
                    and (.commit.message | contains("workflow") | not)
                    and (.commit.message | contains("Merge pull request #") | not)
                  )
                | "\(.sha[0:7]) \(.commit.message | gsub("\n"; " "))"')
          if [ -z "$COMMITS" ]; then
            echo "### No changes, nightly rebuild" > release_notes.md
          else
            RELEASE_NOTES="### Changes in this release:\n"
            while IFS= read -r commit; do
              if [ -n "$commit" ]; then
                RELEASE_NOTES="${RELEASE_NOTES}- ${commit}\n"
              fi
            done <<< "$COMMITS"
            echo -e "$RELEASE_NOTES" > release_notes.md
          fi
          echo "RELEASE_NOTES_FILE=$(pwd)/release_notes.md" >> $GITHUB_ENV

      - name: Get release ID and Mark as Latest
        run: |
          echo "Environment variables:"
          echo "TAG_NAME: ${{ env.TAG_NAME }}"
          echo "Checking GH authentication status..."
          gh auth status
          echo "Attempting to fetch release URL for tag ${TAG_NAME}..."
          RELEASE_URL=$(gh release view ${{ env.TAG_NAME }} --json url -q ".url")
          echo "RELEASE_URL: $RELEASE_URL"
          if [[ -n "$RELEASE_URL" ]]; then
            echo "Release URL found, attempting to mark as latest..."
            if [[ -f "${{ env.RELEASE_NOTES_FILE }}" ]]; then
              echo "Release notes file exists, including --notes-file..."
              gh release edit ${{ env.TAG_NAME }} --latest --draft=false --prerelease=false --notes-file "${{ env.RELEASE_NOTES_FILE }}"
            else
              echo "Release notes file does not exist, skipping --notes-file..."
              gh release edit ${{ env.TAG_NAME }} --latest --draft=false --prerelease=false --notes ""
            fi
            echo "Release marked as latest"
          else
            echo "Release not found, skipping latest release update"
          fi

