#!/bin/sh

LOG_FILE="/var/log/process_monitor.log"
DISK_THRESHOLD_KB=15360

log() {
    LOG_SIZE_LIMIT=524288
    
    if [ -f "$LOG_FILE" ]; then
        LOG_SIZE=$(stat -c%s "$LOG_FILE" 2>/dev/null || stat -f%z "$LOG_FILE" 2>/dev/null)
        if [ -n "$LOG_SIZE" ] && [ "$LOG_SIZE" -ge "$LOG_SIZE_LIMIT" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Log file reached size limit ($LOG_SIZE bytes), rotating..." > "$LOG_FILE"
        fi
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

check_and_start_prudynt() {
    if ! pgrep -f prudynt > /dev/null 2>&1; then
        log "prudynt not running, restarting..."
        /etc/init.d/S31prudynt restart
        sleep 2
        if pgrep -f prudynt > /dev/null 2>&1; then
            log "prudynt started"
        else
            log "E: prudynt start failed"
        fi
    fi
}

check_and_start_send2email_persondetection() {
    if ! pgrep -f send2email_persondetection > /dev/null 2>&1; then
        log "send2email_persondetection not running, restarting..."
        /etc/init.d/S31send2email_persondetection restart
        sleep 2
        if pgrep -f send2email_persondetection > /dev/null 2>&1; then
            log "send2email_persondetection started"
        else
            log "E: send2email_persondetection start failed"
        fi
    fi
}

check_and_start_opc() {
    if ! pgrep -f opc > /dev/null 2>&1; then
        
        CONFIG_FILE="/etc/opc.json"
        OPC_BIN="/usr/sbin/opc"

        if [ ! -x "$OPC_BIN" ]; then
            # log "opc binary not found"
            return
        fi

        if [ ! -f "$CONFIG_FILE" ]; then
            # log "opc.json not found"
            return
        fi

        enable=$(jct "$CONFIG_FILE" get enable 2>/dev/null)
        server_ip=$(jct "$CONFIG_FILE" get server_ip 2>/dev/null)
        server_port=$(jct "$CONFIG_FILE" get server_port 2>/dev/null)
        auth_key=$(jct "$CONFIG_FILE" get auth_key 2>/dev/null)

        if [ "$enable" != "true" ] && [ "$enable" != "1" ]; then
            # log "opc disabled"
            return
        fi

        if [ -z "$server_ip" ] || [ -z "$server_port" ] || [ -z "$auth_key" ]; then
            # log "opc config incomplete"
            return
        fi

        log "opc starting: $server_ip:$server_port"
        /etc/init.d/S39opc start
        sleep 2
        if pgrep -f opc > /dev/null 2>&1; then
            log "opc started"
        else
            log "E: opc start failed"
        fi
    fi
}

check_disk_space() {
    local path="$1"
    local available_kb=$(df -k "$path" 2>/dev/null | awk 'NR==2 {print $4}')
    if [ -n "$available_kb" ] && [ "$available_kb" -lt "$DISK_THRESHOLD_KB" ]; then
        return 1
    fi
    return 0
}

cleanup_old_videos() {
    local save_path="$1"
    
    if [ ! -d "$save_path" ]; then
        return
    fi
    
    local current_date=$(date +%Y%m%d)
    local cleaned=0
    
    log "checking disk space for $save_path"
    
    if check_disk_space "$save_path"; then
        log "disk space sufficient"
        return
    fi
    
    log "disk space low, starting cleanup"
    
    for date_dir in "$save_path"/*; do
        if [ -d "$date_dir" ]; then
            local dir_name=$(basename "$date_dir")
            
            if [ "$dir_name" != "$current_date" ]; then
                log "removing old date directory: $dir_name"
                rm -rf "$date_dir"
                cleaned=1
            fi
        fi
    done
    
    if [ "$cleaned" -eq 1 ]; then
        log "removed old date directories"
    fi
    
    if check_disk_space "$save_path"; then
        log "disk space sufficient after cleanup"
        return
    fi
    
    local today_dir="$save_path/$current_date"
    if [ -d "$today_dir" ]; then
        log "cleaning old videos in current date directory: $current_date"
        for video in "$today_dir"/persondetect_*.mp4; do
            if [ -f "$video" ]; then
                rm -f "$video"
                log "removed video: $(basename "$video")"
                
                if check_disk_space "$save_path"; then
                    log "disk space sufficient after video cleanup"
                    return
                fi
            fi
        done
    fi
    
    log "cleanup completed"
}

check_prudynt_save_path() {
    PRUDYNT_CONFIG="/etc/prudynt.json"
    
    if [ ! -f "$PRUDYNT_CONFIG" ]; then
        return
    fi
    
    save_path=$(jct "$PRUDYNT_CONFIG" get "persondetection.save_path" 2>/dev/null)
    
    if [ -z "$save_path" ]; then
        return
    fi
    
    case "$save_path" in
        /tmp*)
            log "save_path in /tmp, checking disk space: $save_path"
            cleanup_old_videos "$save_path"
            ;;
        *)
            ;;
    esac
}

check_and_start_prudynt
check_and_start_opc
check_prudynt_save_path
