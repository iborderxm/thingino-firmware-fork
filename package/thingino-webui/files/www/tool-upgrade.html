<!DOCTYPE html>
<html lang="zh" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>thingino · 闪存操作</title>
  <script src="/a/theme-init.js"></script>
  <link rel="icon" type="image/svg+xml" href="/a/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/a/main.css">
</head>

<body id="page-tool-upgrade">
<nav data-app-nav></nav>

<main class="pb-4">
  <div class="container" style="min-height:80vh">
    <div data-app-controls></div>

    <section>
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">闪存操作</h2>
          <small>创建备份、触发 OTA 升级，或上传经过验证的映像而无需接触 shell。</small>
          <button type="button" class="btn btn-outline-secondary" id="refreshState" title="从摄像机重新加载值">
            <i class="bi bi-arrow-clockwise"></i> 刷新
          </button>
        </div><!-- .card-header -->
        <div class="card-body">
          <div class="row">

            <div class="col-6">
              <h4>Thingino OTA 更新</h4>
              <small>从 GitHub 获取最新的签名映像并使用所选范围运行 sysupgrade。</small>
              <div class="vstack gap-2 mb-3">
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="full" id="ota-full" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem" checked>
                  <label for="ota-full" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">完整映像</span><br>
                    <span class="small">将擦除所有内容并安装一个全新的映像。不会保留任何自定义。您将不得不从头开始重新配置系统。
                      <span class="text-warning">推荐</span></span>
                  </label>
                </div>
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="partial" id="ota-partial" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem">
                  <label for="ota-partial" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">部分更新</span><br>
                    <span class="small">将保留带有自定义的覆盖分区。很可能会以冲突告终，因此您可能需要重置并重新配置系统。<span class="text-warning">使用风险自负</span></span>
                  </label>
                </div>
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="bootloader" id="ota-bootloader" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem">
                  <label for="ota-bootloader" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">引导加载程序</span><br>
                    <span class="small">仅升级引导加载程序。这不是正常操作，只有在开发人员指示时才应执行。</span>
                  </label>
                </div>
              </div>
              <p class="text-warning small">OTA 升级将在完成时重新启动摄像机。</p>
              <button type="button" class="btn btn-danger" id="otaRun">
                <i class="bi bi-cloud-arrow-down me-1"></i>下载并升级
              </button>
            </div>

            <div class="col-3">
              <h4>手动 sysupgrade 映像</h4>
              <small>上传并刷写经过验证的 .bin 文件。</small>
              <p>
                <label for="firmwareInput">固件映像</label>
                <input type="file" class="form-control" id="firmwareInput" accept=".bin,.img,.gz">
              </p>
              <p class="alert alert-danger small">上传无效的映像可能会导致设备无响应！</p>
              <button type="button" class="btn btn-danger mb-1" id="uploadButton" disabled>
                <i class="bi bi-upload me-1"></i>上传并刷写
              </button>
              <p class="text-secondary small">暂存于 /tmp/fw-web.bin</p>
            </div>

            <div class="col d-none">
              <h4>MTD 分区转储</h4>
              <small>保存原始 /dev/mtdX 块用于低级恢复工作。</small>
              <p class="text-warning small">转储闪存分区仅供恢复专家使用。</p>
              <p>
                <label for="partitionSelect">分区</label>
                <select class="form-select" id="partitionSelect"></select>
              </p>
              <button type="button" class="btn btn-primary mb-3" id="partitionDownload">
                <i class="bi bi-box-arrow-down me-1"></i>保存 mtdblock
              </button>
            </div>

            <div class="col-3">
              <h4>备份配置</h4>
              <small>将自定义内容下载为存档。</small>
              <p class="alert alert-warning small">存档包括 Wi-Fi 凭据、SSH 证书和各种服务的账户。请安全存储！</p>
              <p class="small">请注意，没有恢复程序！
                保存的配置文件可能与最新更改不兼容。
                仅将它们用作创建新配置的参考。</p>
              <button type="button" class="btn btn-primary" id="backupButton">
                <i class="bi bi-download me-1"></i>生成存档
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Flash Progress Modal -->
<div class="modal fade" id="flashProgressModal" tabindex="-1" aria-labelledby="flashProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down" style="height: 80vh; max-height: 80vh;">
    <div class="modal-content h-100 d-flex flex-column">
      <div class="modal-header flex-shrink-0">
        <h5 class="modal-title" id="flashProgressModalLabel">闪存进度</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body flex-grow-1 overflow-hidden p-0" style="min-height: 0;">
        <pre id="output" class="terminal ansi-log overflow-auto h-100 m-0" data-reboot="true"></pre>
      </div>
      <div class="modal-footer flex-shrink-0">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="copyLog" disabled>
          <i class="bi bi-clipboard me-1"></i>复制日志
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<footer data-app-footer></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script src="/a/main.js"></script>
<script src="/a/runtime-config.js"></script>
<script src="/a/navigation.js"></script>
<script src="/a/footer.js"></script>
<script src="/a/tool-upgrade.js"></script>
</body>
</html>
